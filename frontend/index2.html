<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Polly Lab FE</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; margin-bottom: 14px; }
    label { display: block; font-size: 13px; opacity: .85; margin: 10px 0 6px; }
    input, select, textarea, button { font: inherit; }
    input[type="text"], select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; min-width: 240px; }
    textarea { width: 100%; min-height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 9px 12px; border: 1px solid #333; border-radius: 10px; background: #111; color: #fff; cursor: pointer; }
    button.secondary { background: #fff; color: #111; border-color: #999; }
    button:disabled { opacity: .5; cursor: not-allowed; }
    .muted { font-size: 12px; color: #666; }
    pre { background: #0b1020; color: #d7e2ff; padding: 12px; border-radius: 10px; overflow: auto; }
    a { word-break: break-all; }
    .pill { display:inline-block; padding: 3px 8px; border-radius: 999px; background:#f2f2f2; font-size:12px; }
  </style>
</head>

<body>
  <h1>Polly Lab FE <span class="pill">local</span></h1>
  <p class="muted">Express API 서버에 붙는 간단 FE. (/voices /tts /marks)</p>

  <div class="card">
    <h3>API 서버 설정</h3>
    <div class="row">
      <div>
        <label>API Base URL</label>
        <input id="baseUrl" type="text" value="http://localhost:3001" />
        <div class="muted">서버 포트가 다르면 바꾸세요.</div>
      </div>
      <div style="align-self:flex-end;">
        <button class="secondary" id="btnHealth">/health 체크</button>
      </div>
    </div>
    <pre id="healthOut">대기중...</pre>
  </div>

  <div class="card">
    <h3>보이스 목록</h3>
    <div class="row">
      <div>
        <label>languageCode</label>
        <select id="lang">
          <option value="ko-KR" selected>ko-KR</option>
          <option value="en-US">en-US</option>
          <option value="ja-JP">ja-JP</option>
          <option value="zh-CN">zh-CN</option>
        </select>
      </div>
      <div style="align-self:flex-end;">
        <button class="secondary" id="btnVoices">/voices 불러오기</button>
      </div>
      <div>
        <label>VoiceId</label>
        <select id="voiceId"></select>
      </div>
    </div>
    <pre id="voicesOut">대기중...</pre>
  </div>

  <div class="card">
    <h3>TTS 생성</h3>
    <label>Text (or SSML)</label>
    <textarea id="text">안녕하세요. Amazon Polly 테스트입니다.</textarea>

    <div class="row">
      <div>
        <label>textType</label>
        <select id="textType">
          <option value="text" selected>text</option>
          <option value="ssml">ssml</option>
        </select>
      </div>

      <div>
        <label>engine</label>
        <select id="engine">
          <option value="standard" selected>standard</option>
          <option value="neural">neural</option>
        </select>
      </div>

      <div>
        <label>format</label>
        <select id="format">
          <option value="mp3" selected>mp3</option>
          <option value="ogg_vorbis">ogg_vorbis</option>
          <option value="pcm">pcm</option>
        </select>
      </div>

      <div>
        <label>sampleRate (pcm only)</label>
        <select id="sampleRate">
          <option value="8000">8000</option>
          <option value="16000">16000</option>
          <option value="22050" selected>22050</option>
        </select>
      </div>

      <div style="display:flex; align-items:flex-end; gap:10px;">
        <label style="margin:0;">
          <input id="saveToS3" type="checkbox" />
          S3에 저장 + Presigned URL
        </label>
      </div>

      <div style="align-self:flex-end;">
        <button id="btnTts">/tts 실행</button>
      </div>
    </div>

    <audio id="player" controls style="width:100%; margin-top:10px;"></audio>
    <div id="ttsLinks" class="muted" style="margin-top:8px;"></div>
    <pre id="ttsOut">대기중...</pre>
  </div>

  <div class="card">
    <h3>Speech Marks</h3>

    <div class="row">
      <div>
        <label>marks</label>
        <select id="marks" multiple size="4">
          <option value="word" selected>word</option>
          <option value="sentence" selected>sentence</option>
          <option value="viseme">viseme</option>
          <option value="ssml">ssml</option>
        </select>
        <div class="muted">Ctrl/Shift로 다중 선택</div>
      </div>

      <div style="align-self:flex-end;">
        <button class="secondary" id="btnMarks">/marks 실행</button>
      </div>
    </div>

    <pre id="marksOut">대기중...</pre>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    function baseUrl() {
      return $("baseUrl").value.replace(/\/+$/, "");
    }

    function selectedMarks() {
      return Array.from($("marks").selectedOptions).map(o => o.value);
    }

    function setPre(id, obj) {
      $(id).textContent = typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
    }

    async function apiGet(path) {
      const res = await fetch(baseUrl() + path);
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    async function apiPost(path, body) {
      const res = await fetch(baseUrl() + path, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });
      const json = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(json.error || res.statusText);
      return json;
    }

    async function refreshVoices() {
      setPre("voicesOut", "불러오는 중...");
      const languageCode = $("lang").value;
      const data = await apiGet(`/voices?languageCode=${encodeURIComponent(languageCode)}`);
      setPre("voicesOut", data);

      const voiceSelect = $("voiceId");
      voiceSelect.innerHTML = "";
      (data.voices || []).forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.Id;
        opt.textContent = `${v.Id} (${v.Gender || ""})`;
        voiceSelect.appendChild(opt);
      });

      // default Seoyeon 있으면 선택
      const hasSeoyeon = Array.from(voiceSelect.options).some(o => o.value === "Seoyeon");
      if (hasSeoyeon) voiceSelect.value = "Seoyeon";
    }

    function setAudioFromBase64(contentType, audioBase64) {
      // mp3/ogg는 브라우저 재생 OK
      const url = `data:${contentType};base64,${audioBase64}`;
      $("player").src = url;
      $("player").play().catch(()=>{});
    }

    $("btnHealth").addEventListener("click", async () => {
      try {
        setPre("healthOut", "체크 중...");
        const data = await apiGet("/health");
        setPre("healthOut", data);
      } catch (e) {
        setPre("healthOut", { error: e.message });
      }
    });

    $("btnVoices").addEventListener("click", async () => {
      try { await refreshVoices(); }
      catch (e) { setPre("voicesOut", { error: e.message }); }
    });

    $("btnTts").addEventListener("click", async () => {
      const btn = $("btnTts");
      btn.disabled = true;
      $("ttsLinks").innerHTML = "";
      setPre("ttsOut", "생성 중...");
      try {
        const body = {
          text: $("text").value,
          textType: $("textType").value,
          voiceId: $("voiceId").value || "Seoyeon",
          engine: $("engine").value,
          format: $("format").value,
          sampleRate: $("sampleRate").value,
          saveToS3: $("saveToS3").checked
        };

        const data = await apiPost("/tts", body);
        setPre("ttsOut", data);

        if (data.savedToS3) {
          // presignedUrl로 재생도 가능 (mp3/ogg일 때)
          const a = document.createElement("a");
          a.href = data.presignedUrl;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = "Presigned URL 열기";
          $("ttsLinks").appendChild(a);

          if (data.contentType && /audio\/(mpeg|ogg)/.test(data.contentType)) {
            $("player").src = data.presignedUrl;
            $("player").play().catch(()=>{});
          } else {
            $("player").removeAttribute("src");
          }
        } else {
          // Base64 반환 재생
          setAudioFromBase64(data.contentType || "audio/mpeg", data.audioBase64);
        }
      } catch (e) {
        setPre("ttsOut", { error: e.message });
      } finally {
        btn.disabled = false;
      }
    });

    $("btnMarks").addEventListener("click", async () => {
      const btn = $("btnMarks");
      btn.disabled = true;
      setPre("marksOut", "생성 중...");
      try {
        const body = {
          text: $("text").value,
          textType: $("textType").value,
          voiceId: $("voiceId").value || "Seoyeon",
          engine: $("engine").value,
          marks: selectedMarks()
        };
        const data = await apiPost("/marks", body);
        setPre("marksOut", data);
      } catch (e) {
        setPre("marksOut", { error: e.message });
      } finally {
        btn.disabled = false;
      }
    });

    // 초기: voices 자동 한번 불러오기(실패해도 무시)
    refreshVoices().catch(()=>{});
  </script>
</body>
</html>
